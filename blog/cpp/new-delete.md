## [CPP] new å’Œ delete

å‚è€ƒï¼š

+ [1] https://www.cnblogs.com/wangpei0522/p/4476470.html
+ [2] https://stackoverflow.com/questions/8940090/is-it-safe-on-linux-to-mix-new-and-delete

## ç°è±¡

æŸæ—¥å‘ç°ä¸€ä¸ªå¥‡æ€ªçš„ç°è±¡ï¼Œå…ˆçœ‹ä»¥ä¸‹ä»£ç ï¼š

```cpp
int *p = new int[10];
delete p;
```

æˆ‘çŸ¥é“åº”è¯¥ç”¨ `delete[]` ï¼Œä½†å®é™…ä¸Šå¯¹äºåŸºæœ¬æ•°æ®ç±»å‹ï¼Œåœ¨è¿™é‡Œä½¿ç”¨ `delete/delete[]` ä¼¼ä¹éƒ½å¯ä»¥ã€‚

ç»§ç»­å°è¯•ä¸€ä¸‹ `class`:

```cpp
class Basic
{
public:
    Basic() { cout << "Basic" << endl; }
    ~Basic() { cout << "~Basic" << endl; }
};
int main()
{
    Basic *b = new Basic[10];
    delete b;
}
```

å¯¹äºä¸Šè¿°ä»£ç ï¼Œèƒ½ç¼–è¯‘æˆåŠŸï¼Œ`~Basic` åªè¾“å‡º 1 æ¬¡ï¼Œéšåå‡ºç°è¿è¡Œæ—¶é”™è¯¯ã€‚ä½†æ˜¯å‡å¦‚æŠŠææ„å‡½æ•° `~Basic` å»æ‰ï¼Œè¿™ä¸ªè¿è¡Œæ—¶é”™è¯¯å°±ä¼šæ¶ˆå¤±ã€‚

ç»è¿‡åœ¨ Stackoverflow çš„æœç´¢ï¼Œæ®è¯´è¿™æ˜¯å› ä¸º `new[4]` åŒ…å«ä¸€ä¸ªä¿¡æ¯å¤´ï¼Œè€Œ `new` ä¸åŒ…å«ä¿¡æ¯å¤´ï¼Œ**`delete` éœ€è¦æ ¹æ®ä¿¡æ¯å¤´æ¥ç¡®å®šææ„å‡½æ•°çš„è°ƒç”¨æ¬¡æ•°**ã€‚ `new []` ç”³è¯·çš„å†…å­˜ç”¨ `delete` æ¥é‡Šæ”¾å¯¹è±¡çš„æå‰æ˜¯ï¼šå¯¹è±¡çš„ç±»å‹æ˜¯å†…ç½®ç±»å‹æˆ–è€…æ˜¯æ— è‡ªå®šä¹‰çš„ææ„å‡½æ•°çš„ç±»ã€‚

ç°åœ¨æ¥æ¢ç©¶ä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆ `new []` ä¹Ÿèƒ½ç”¨ `delete` é‡Šæ”¾ï¼Ÿï¼ˆæœ‰ä¸€è¯´ä¸€ï¼Œè¿™ä¸ªé—®é¢˜æ¯”è¾ƒè ¢ï¼Œå› ä¸ºè¿™æ ·å†™ä»£ç ä¼šè¢«éª‚æ­»å§ï¼‰

ç°åœ¨æ¥çœ‹å‡ ä¸ªæœ‰è¶£çš„ç°è±¡ï¼Œåç»­ä¼šé€šè¿‡ç®€å•çš„å®éªŒéªŒè¯å®ƒä»¬ã€‚

1. å¦‚æœæ˜¯ `int` ç­‰åŸºæœ¬æ•°æ®ç±»å‹ï¼šä½¿ç”¨ `new []` ç”³è¯·å†…å­˜ï¼Œä½¿ç”¨ `delete` é‡Šæ”¾ï¼Œä¸ä¼šå†…å­˜æ³„æ¼ã€‚
2. å¦‚æœæ˜¯ `class`ï¼š
   - 2.1 å®ç°äº†ææ„å‡½æ•°ï¼šä½¿ç”¨ `delete` å»é‡Šæ”¾ `new []` ç”³è¯·çš„å†…å­˜ï¼Œä¼šå‘ç”Ÿè¿è¡Œæ—¶é”™è¯¯ã€‚
   - 2.2 æ²¡æœ‰å®ç°ææ„å‡½æ•°ï¼šå¯ä»¥ä½¿ç”¨ `delete` å»é‡Šæ”¾ `new []` ç”³è¯·çš„å†…å­˜ï¼Œä¸ä¼šå†…å­˜æ³„æ¼ã€‚

## å®éªŒ

ä¸‹åˆ—å®éªŒå‡åœ¨ MacOS ä¸Šè¿›è¡Œã€‚

ä¸‹é¢è®¾è®¡å®éªŒå¯¹ä¸Šè¿°çš„ç°è±¡éªŒè¯ã€‚å¦‚ä½•è¯´æ˜å†…å­˜ä¸æ³„æ¼ï¼Ÿä¸”çœ‹å¦‚ä¸‹ä»£ç ï¼š

```cpp
void test1()
{
    // ä¸ä¼šå†…å­˜æ³„æ¼
    int *p = new int[4];
    cout << p << endl;  // 0x7f7fd6c05a10
    delete p;
    int *q = new int[4];
    cout << q << endl;  // 0x7f7fd6c05a10
}
```

 ä¸è®ºè¿è¡Œå¤šå°‘æ¬¡ï¼Œä¸Šè¿° `p, q` çš„å€¼æ€»æ˜¯ä¸€æ ·çš„ã€‚è¯´æ˜ `delete p` æŠŠ 4 ä¸ª `int` çš„å†…å­˜éƒ½æˆåŠŸå›æ”¶ï¼Œå› æ­¤åœ¨ä¸‹ä¸€æ¬¡ç”³è¯·å†…å­˜æ—¶æ‰ä¼šä» `p` çš„èµ·å§‹ä½ç½®å¼€å§‹ã€‚è¯¥ç¨‹åºéªŒè¯ä¸Šè¿°çš„ç¬¬ 1 ä¸ªç°è±¡ã€‚

> æŒ‰ç…§æˆ‘åŸæ¥çš„ç†è§£ï¼Œæˆ‘ä»¥ä¸º `delete p` ä»…ä»…ä¼šé‡Šæ”¾ `p` æŒ‡å‘çš„ 4 ä¸ªå­—èŠ‚çš„å†…å­˜ï¼Œç„¶åä¼šé€ æˆå‰©ä¸‹ 12 å­—èŠ‚çš„å†…å­˜æ³„æ¼ã€‚

å†çœ‹çœ‹ `class` æ—¶çš„æƒ…å†µã€‚

```cpp
class A { public: int val; };
void test2()
{
    // ä¹Ÿä¸ä¼šå†…å­˜æ³„æ¼
    auto p = new A[4];
    cout << p << endl;
    delete p;
    auto q = new A[4];
    cout << q << endl;
}
```

 è¿™é‡Œ `p, q` çš„å€¼ä¹Ÿæ€»æ˜¯ç›¸åŒçš„ï¼Œå¯éªŒè¯ä¸Šè¿°çš„ç°è±¡ 2.2 ã€‚

å¦‚æœåŠ å…¥ææ„å‡½æ•°ï¼š

```cpp
class B
{
public:
    int val;
    B() : val(0) { cout << "B" << endl; }
    ~B() { cout << "~B" << endl; }
};
void test3()
{
    auto p = new B[4];
    delete p;
}
```

ä¸Šè¿°ä»£ç è¾“å‡º `B` ä¸‰æ¬¡ï¼Œ`~B` ä¸€æ¬¡ï¼Œç„¶åç¨‹åºå´©æºƒï¼Œåç»­ä¼šè§£æåŸå› ã€‚ç°åœ¨æŠŠ `test3` æ”¹ä¸ºå¦‚ä¸‹ä»£ç ï¼š

```cpp
void test3()
{
    cout << sizeof(B) << endl; // 4
    auto p = new B[4];
    cout << p << endl; // 0x7fda10405a18
    auto q = new B[4];
    cout << q << endl; // 0x7fef51405a38
}
```

è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`B` çš„å¤§å°æ˜¯ 4 å­—èŠ‚ï¼Œå› æ­¤ `p` çš„å†…å­˜é•¿åº¦åº”ä¸º 16 å­—èŠ‚ï¼Œ`q` åº”è¯¥ä» `0x5a18 + 0x0010 = 0x5a28` å¼€å§‹æ‰å¯¹ï¼Œä½†å®é™…ä¸Š `q` ä» `0x5a38` å¼€å§‹ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¸­é—´çš„ 16 å­—èŠ‚åšä»€ä¹ˆå»äº†å‘¢ï¼Ÿè¿™é‡Œçš„ 16 å­—èŠ‚å°±æ˜¯æ–‡ç« å¼€å§‹æåˆ°çš„ `new []` åŠ å…¥çš„ä¿¡æ¯å¤´ã€‚

å®šä¹‰ `print4int(p)` ï¼Œå®ƒçš„ä½œç”¨æ˜¯è¾“å‡º `p` å‰é¢ 16 ä¸ªå­—èŠ‚çš„å†…å®¹ï¼Œæ¯ 4 ä¸ªå­—èŠ‚ä»¥ `int32_t` çš„å½¢å¼è¾“å‡ºã€‚ä¾‹å¦‚ `p = 16` æ—¶ï¼Œè¯¥å‡½æ•°è¾“å‡º `0 - 15` è¿™ 16 ä¸ªå­—èŠ‚ã€‚

```cpp
void print4int(int32_t *p)
{
    p -= 4;
    cout << "memory at " << p << ": ";
    for (int i = 0; i < 4; i++)
        cout << p[i] << ' ';
    cout << endl;
}
```

 ä¸‹é¢å†çœ‹ `test3` ï¼š

```cpp
void test3()
{
    auto p = new B[4];
    cout << p << endl;        // 0x7fe0b5c05a18
    print4int((int32_t *)p);  // memory at 0x7fe0b5c05a08: 0 0 4 0
    auto q = new B[16];
    cout << q << endl;        // 0x7fe0b5c05a38
    print4int((int32_t *)q);  // memory at 0x7fe0b5c05a28: 0 0 16 0 
}
```

ä¿®æ”¹æ•°ç»„é•¿åº¦ï¼Œé‡å¤æµ‹è¯•ï¼Œå¯ä»¥å‘ç°ï¼Œå‰é¢ 4 ä¸ª `int` ä¸­ï¼Œç¬¬ 3 ä¸ª `int` æ€»æ˜¯ä¸ `new []` ç”³è¯·çš„é•¿åº¦ä¸€è‡´ã€‚ï¼ˆå®é™…ä¸Šï¼Œåªæœ‰ 2 ä¸ª `int` æ˜¯ä¿¡æ¯å¤´ï¼Œå¤šå‡ºæ¥çš„ 2 ä¸ªæ˜¯ç”±äºå­—èŠ‚å¯¹é½çš„ç¼˜æ•…ã€‚ï¼‰

è¿™æ—¶å€™é—®é¢˜æ¥äº†ï¼Œä¸ºä»€ä¹ˆ `new int[4]` è¿™ç§æƒ…å†µå°±æ²¡æœ‰ä¿¡æ¯å¤´å‘¢ï¼Ÿè¿™æ˜¯ç”±äºç¼–è¯‘å™¨çš„åŸå› ï¼Œå¦‚æœç¼–è¯‘å™¨æ£€æŸ¥åˆ°ï¼Œå¦‚æœæ˜¯ `base type`ï¼Œ`new[]` æ“ä½œå°±ä¼šçœå»å‰é¢çš„ä¿¡æ¯å¤´ï¼Œåé¢å‘ç”Ÿ `delete` é‡Šæ”¾ `new[]` çš„æ—¶å€™ï¼Œ`free` è°ƒç”¨çš„ `ptr` å’Œ `malloc` è°ƒç”¨çš„ `ptr` ä¹Ÿå°±ä¸€è‡´äº†ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ `base type` å¯ä»¥ç”¨ `delete` æ¥é‡Šæ”¾ `new []` ã€‚



## åˆ†æ

æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œ`new/delete` æœ€ç»ˆæ˜¯è°ƒç”¨ `malloc/free` æ¥å®Œæˆå†…å­˜çš„ç”³è¯·å’Œé‡Šæ”¾çš„ï¼Œæ­¤å¤– `new/delete` ä¼šè°ƒç”¨æ„é€ /ææ„å‡½æ•°ï¼Œè¿™æ˜¯  `malloc/free` æ²¡æœ‰åšçš„ã€‚

ä¾‹å¦‚ `p = new B[4]` å®Œæˆçš„å·¥ä½œæœ‰ 2 ä¸ªï¼Œä¸€æ˜¯ç”³è¯·å†…å­˜ï¼ŒäºŒæ˜¯æ‰§è¡Œ `B` çš„æ„é€ å‡½æ•°ï¼ˆ4æ¬¡ï¼‰ï¼›åŒç† `delete[] p` ç±»ä¼¼ï¼Œå…ˆæ‰§è¡Œ `B` çš„ææ„å‡½æ•°ï¼ˆ4 æ¬¡ï¼‰ï¼Œç„¶åé‡Šæ”¾å†…å­˜ã€‚

`new []` ç”³è¯·çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ`Bookkeeping` å°±æ˜¯æŒ‡ä¸Šè¿°çš„æ‰€è°“çš„ã€Œä¿¡æ¯å¤´ã€ã€‚

```c
| Bookkeeping | First Object | Second Object |....
^             ^
|             |
|             p2: This is what is returned by new[]
|
p1:this is what is returned by malloc()
```

è¿™èƒ½å¤Ÿè§£é‡Šå½“æ•°æ®ç±»å‹ä¸ºæŸä¸ªç±»æ—¶ï¼Œä¸ºä»€ä¹ˆç”¨ `delete` å»é‡Šæ”¾ `new []` ä¼šå¤±æ•ˆã€‚

åœ¨ç¨‹åºå½“ä¸­ï¼Œæˆ‘ä»¬ç”¨ `ptr = new B[4]` å¾—åˆ°çš„æ˜¯ä¸Šè¿°çš„ `p2` ã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨ `delete ptr` å»é‡Šæ”¾ï¼Œå…ˆè°ƒç”¨ç¬¬ä¸€ä¸ªå¯¹è±¡ `B[0]` çš„ææ„å‡½æ•°ï¼Œç„¶åè°ƒç”¨ `free(ptr)` ï¼Œä½†æ˜¯åœ¨ C++ çš„å†…å­˜ç®¡ç†å½“ä¸­ï¼Œè®°å½•çš„æ˜¯ä¸Šè¿° `p1` çš„å€¼ï¼Œ`ptr` ä¸è¢«è®¤ä¸ºæ˜¯ç”³è¯·çš„å†…å­˜åœ°å€ï¼Œæ‰€ä»¥ `free(ptr)` ä¼šå‘ç”Ÿ `pointer being freed was not allocated` çš„é”™è¯¯ï¼ˆMacOSä¸Šçš„è¾“å‡ºï¼‰ã€‚

è€Œä½¿ç”¨ `delete[] ptr`ï¼Œåˆ™å…ˆæ ¹æ®ä¿¡æ¯å¤´è°ƒç”¨è‹¥å¹²æ¬¡ææ„å‡½æ•°ï¼Œç„¶ååœ¨è°ƒç”¨ `free(ptr - X)` ï¼Œ`X` æ˜¯ Bookkeeping çš„é•¿åº¦ã€‚

æ—¢ç„¶æ¸…æ¥šäº†è¿™ä¸ªç»†èŠ‚ï¼Œæˆ‘ä»¬ä¹Ÿå°±èƒ½éªšæ“ä½œä¸€ä¸‹ï¼šä½¿ç”¨ `free / delete` æ¥é‡Šæ”¾ `new B[4]` ã€‚

```cpp
void test4()
{
    auto p = new B[4];
    cout << p << endl;       // 0x7f8f14405a18
    print4int((int32_t *)p); // memory at 0x7f8f14405a08: 0 0 4 0

    uint32_t *q = (uint32_t *)p;
    q -= 2;
    cout << q << endl;       // 0x7f8f14405a10
    delete q;
    // free(q) is also ok
}
// ä½†è¿™ä»æ—§æ˜¯ä¸å®‰å…¨çš„ï¼Œå¯èƒ½ä¼šé€ æˆå†…å­˜æ³„æ¼çš„ï¼Œå› ä¸º 4 ä¸ª B å¯¹è±¡ææ„å‡½æ•°æ²¡æœ‰è¢«åˆç†è°ƒç”¨
```

## ç»“è®º

To be honestï¼Œå†™ä»£ç åªè¦éµå¾ª `new/delete` å’Œ `new[]/delete[]` é…å¯¹ä½¿ç”¨çš„åŸåˆ™ï¼Œç„¶åå°±æ²¡è¿™æ–‡ç« ä»€ä¹ˆäº‹äº†ã€‚

ï¼ˆæäº†åŠå¤©ï¼Œè¿™ç¯‡æ–‡ç« æœ‰ç‚¹åƒåœ¨ã€Œæ— ç—…å‘»åŸã€ğŸ¤¡ï¼‰